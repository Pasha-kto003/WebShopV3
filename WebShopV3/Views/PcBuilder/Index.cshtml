@using WebShopV3.Models
@{
    var components = ViewBag.Components as List<Component>;
    ViewData["Title"] = "Конфигуратор ПК";
}

<div class="min-h-screen bg-dark pt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-white mb-4">Конфигуратор ПК</h1>
            <p class="text-xl text-gray-400">Соберите свой идеальный компьютер с проверкой совместимости</p>
        </div>

        <!-- Отладочная информация (можно удалить после проверки) -->
        @if (components == null || !components.Any())
        {
            <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-6">
                <div class="text-red-400 text-sm">
                    ❌ Компоненты не загружены или отсутствуют в базе данных
                </div>
            </div>
        }
        else
        {
            <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4 mb-6 hidden">
                <div class="text-green-400 text-sm">
                    ✅ Загружено компонентов: @components.Count
                </div>
            </div>
        }

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Левая колонка - Выбор компонентов -->
            <div class="lg:col-span-2">
                <div class="bg-dark-card rounded-2xl p-6 border border-gray-800 mb-6">
                    <h2 class="text-2xl font-bold text-white mb-6">Выбор компонентов</h2>
                    
                    <div class="space-y-6" id="componentCategories">
                        @if (components != null && components.Any())
                        {
                            <!-- Материнские платы -->
                            <div class="component-category">
                                <div class="flex items-center mb-4">
                                    <span class="text-2xl mr-3">🔌</span>
                                    <h3 class="text-xl font-bold text-white">Материнские платы</h3>
                                    <span class="ml-2 text-xs text-red-400">* обязательный</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-MB">
                                    @foreach (var component in components.Where(c => c.Type == "MB"))
                                    {
                                        <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                             data-component-id="@component.Id"
                                             onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, '@component.Socket', '@component.MemoryType', '@component.FormFactor')">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                            </div>
                                            <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                            <div class="space-y-1 text-xs">
                                                @if (!string.IsNullOrEmpty(component.Socket))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Сокет:</span>
                                                        <span class="text-white">@component.Socket</span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(component.MemoryType))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Память:</span>
                                                        <span class="text-white">@component.MemoryType</span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(component.FormFactor))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Форм-фактор:</span>
                                                        <span class="text-white">@component.FormFactor</span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                    @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                </span>
                                                <button class="text-xs text-primary hover:underline">Добавить</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Процессоры -->
                            <div class="component-category">
                                <div class="flex items-center mb-4">
                                    <span class="text-2xl mr-3">⚙️</span>
                                    <h3 class="text-xl font-bold text-white">Процессоры</h3>
                                    <span class="ml-2 text-xs text-red-400">* обязательный</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-CPU">
                                    @foreach (var component in components.Where(c => c.Type == "CPU"))
                                    {
                                        <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                             data-component-id="@component.Id"
                                             onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, '@component.Socket', null, null)">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                            </div>
                                            <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                            <div class="space-y-1 text-xs">
                                                @if (!string.IsNullOrEmpty(component.Socket))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Сокет:</span>
                                                        <span class="text-white">@component.Socket</span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                    @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                </span>
                                                <button class="text-xs text-primary hover:underline">Добавить</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Оперативная память -->
                            <div class="component-category">
                                <div class="flex items-center mb-4">
                                    <span class="text-2xl mr-3">💾</span>
                                    <h3 class="text-xl font-bold text-white">Оперативная память</h3>
                                    <span class="ml-2 text-xs text-red-400">* обязательный</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-RAM">
                                    @foreach (var component in components.Where(c => c.Type == "RAM"))
                                    {
                                        <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                             data-component-id="@component.Id"
                                             onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, null, '@component.MemoryType', null)">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                            </div>
                                            <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                            <div class="space-y-1 text-xs">
                                                @if (!string.IsNullOrEmpty(component.MemoryType))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Тип:</span>
                                                        <span class="text-white">@component.MemoryType</span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                    @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                </span>
                                                <button class="text-xs text-primary hover:underline">Добавить</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Блоки питания -->
                            <div class="component-category">
                                <div class="flex items-center mb-4">
                                    <span class="text-2xl mr-3">⚡</span>
                                    <h3 class="text-xl font-bold text-white">Блоки питания</h3>
                                    <span class="ml-2 text-xs text-red-400">* обязательный</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-PSU">
                                    @foreach (var component in components.Where(c => c.Type == "PSU"))
                                    {
                                        <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                             data-component-id="@component.Id"
                                             onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, null, null, null, '@component.PowerConnector')">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                            </div>
                                            <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                            <div class="space-y-1 text-xs">
                                                @if (!string.IsNullOrEmpty(component.PowerConnector))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Разъемы:</span>
                                                        <span class="text-white">@component.PowerConnector</span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                    @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                </span>
                                                <button class="text-xs text-primary hover:underline">Добавить</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Корпуса -->
                            <div class="component-category">
                                <div class="flex items-center mb-4">
                                    <span class="text-2xl mr-3">🏠</span>
                                    <h3 class="text-xl font-bold text-white">Корпуса</h3>
                                    <span class="ml-2 text-xs text-red-400">* обязательный</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-Case">
                                    @foreach (var component in components.Where(c => c.Type == "Case"))
                                    {
                                        <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                             data-component-id="@component.Id"
                                             onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, null, null, '@component.FormFactor')">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                            </div>
                                            <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                            <div class="space-y-1 text-xs">
                                                @if (!string.IsNullOrEmpty(component.FormFactor))
                                                {
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-500">Форм-фактор:</span>
                                                        <span class="text-white">@component.FormFactor</span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                    @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                </span>
                                                <button class="text-xs text-primary hover:underline">Добавить</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Видеокарты (необязательные) -->
                            @if (components.Any(c => c.Type == "GPU"))
                            {
                                <div class="component-category">
                                    <div class="flex items-center mb-4">
                                        <span class="text-2xl mr-3">🎮</span>
                                        <h3 class="text-xl font-bold text-white">Видеокарты</h3>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="components-GPU">
                                        @foreach (var component in components.Where(c => c.Type == "GPU"))
                                        {
                                            <div class="component-card bg-gray-800/50 rounded-xl p-4 border-2 border-gray-700 hover:border-primary/50 transition duration-200 cursor-pointer"
                                                 data-component-id="@component.Id"
                                                 onclick="toggleComponent(@component.Id, '@component.Type', '@component.Name', @component.Price, null, null, null, '@component.PowerConnector')">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h4 class="text-white font-semibold text-sm">@component.Name</h4>
                                                    <div class="text-primary font-bold">@component.Price.ToString("C")</div>
                                                </div>
                                                <div class="text-gray-400 text-xs mb-3 line-clamp-2">@component.Description</div>
                                                <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                                                    <span class="text-xs @(component.Quantity > 0 ? "text-green-400" : "text-red-400")">
                                                        @(component.Quantity > 0 ? $"В наличии: {component.Quantity}" : "Нет в наличии")
                                                    </span>
                                                    <button class="text-xs text-primary hover:underline">Добавить</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-gray-400 py-8">
                                <div class="text-4xl mb-2">😔</div>
                                <p>Компоненты для сборки отсутствуют</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Правая колонка - Конфигурация -->
            <div class="lg:col-span-1">
                <div class="bg-dark-card rounded-2xl p-6 border border-gray-800 sticky top-24">
                    <h2 class="text-2xl font-bold text-white mb-6">Ваша конфигурация</h2>
                    
                    <div id="configurationList" class="space-y-4 mb-6">
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">🖥️</div>
                            <p>Выберите компоненты для сборки</p>
                        </div>
                    </div>

                    <div id="compatibilityResult" class="mb-6">
                        <!-- Результаты проверки совместимости -->
                    </div>

                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-400">Итого:</span>
                            <span id="totalPrice" class="text-2xl font-bold text-primary">0 ₽</span>
                        </div>

                        <button id="saveConfiguration" 
                                class="w-full bg-primary text-dark py-3 rounded-lg font-bold hover:bg-green-400 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                disabled>
                            Сохранить конфигурацию
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()
@section Scripts {
    <script>
        let selectedComponents = [];
        let totalPrice = 0;

        // Инициализация при загрузке страницы
        // Переключение выбора компонента
        function toggleComponent(id, type, name, price, socket, memoryType, formFactor, powerConnector) {
            const component = {
                id: id,
                type: type,
                name: name,
                price: price,
                socket: socket,
                memoryType: memoryType,
                formFactor: formFactor,
                powerConnector: powerConnector
            };

            const existingIndex = selectedComponents.findIndex(sc => sc.id === id);
            
            if (existingIndex > -1) {
                // Удаляем компонент
                selectedComponents.splice(existingIndex, 1);
            } else {
                // Добавляем компонент, проверяя тип
                const existingSameType = selectedComponents.find(sc => sc.type === type);
                if (existingSameType) {
                    if (!confirm(`Заменить ${getComponentTypeName(type)} "${existingSameType.name}" на "${name}"?`)) {
                        return;
                    }
                    // Удаляем старый компонент того же типа
                    selectedComponents = selectedComponents.filter(sc => sc.type !== type);
                }
                selectedComponents.push(component);
            }

            updateConfigurationDisplay();
            updateComponentCards();
            checkCompatibility();
        }

        // Обновление отображения конфигурации
        function updateConfigurationDisplay() {
            const configurationList = document.getElementById('configurationList');
            const totalPriceElement = document.getElementById('totalPrice');
            const saveButton = document.getElementById('saveConfiguration');

            // Пересчитываем общую цену
            totalPrice = selectedComponents.reduce((sum, component) => sum + component.price, 0);
            totalPriceElement.textContent = formatPrice(totalPrice);

            if (selectedComponents.length === 0) {
                configurationList.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-2">🖥️</div>
                        <p>Выберите компоненты для сборки</p>
                    </div>
                `;
                saveButton.disabled = true;
                return;
            }

            // Отображаем выбранные компоненты
            configurationList.innerHTML = selectedComponents.map(component => `
                <div class="selected-component bg-gray-800/30 rounded-lg p-3 border border-gray-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-white font-semibold text-sm">${component.name}</div>
                            <div class="text-gray-400 text-xs">${getComponentTypeName(component.type)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-primary font-semibold">${formatPrice(component.price)}</div>
                            <button onclick="toggleComponent(${component.id}, '${component.type}', '${component.name}', ${component.price}, '${component.socket}', '${component.memoryType}', '${component.formFactor}', '${component.powerConnector}')" 
                                    class="text-red-400 hover:text-red-300 text-xs mt-1">
                                ✕ Удалить
                            </button>
                        </div>
                    </div>
                    ${getComponentDetails(component)}
                </div>
            `).join('');

            saveButton.disabled = false;
        }

        // Получение деталей компонента для отображения
        function getComponentDetails(component) {
            const details = [];
            
            if (component.socket) details.push(`Сокет: ${component.socket}`);
            if (component.memoryType) details.push(`Память: ${component.memoryType}`);
            if (component.formFactor) details.push(`Форм-фактор: ${component.formFactor}`);
            if (component.powerConnector) details.push(`Разъемы: ${component.powerConnector}`);
            
            return details.length > 0 ? 
                `<div class="text-gray-500 text-xs mt-1">${details.join(', ')}</div>` : '';
        }

        // Обновление карточек компонентов (подсветка выбранных)
        function updateComponentCards() {
            document.querySelectorAll('.component-card').forEach(card => {
                const componentId = parseInt(card.getAttribute('data-component-id'));
                const isSelected = selectedComponents.some(sc => sc.id === componentId);
                
                card.classList.toggle('border-primary', isSelected);
                card.classList.toggle('border-gray-700', !isSelected);
                
                const button = card.querySelector('button');
                if (button) {
                    button.textContent = isSelected ? 'Удалить' : 'Добавить';
                    button.className = `text-xs ${isSelected ? 'text-red-400' : 'text-primary'} hover:underline`;
                }
            });
        }

        // Проверка совместимости компонентов
        async function checkCompatibility() {
            const compatibilityResult = document.getElementById('compatibilityResult');
            
            if (selectedComponents.length === 0) {
                compatibilityResult.innerHTML = '';
                return;
            }

            // Показываем загрузку
            compatibilityResult.innerHTML = `
                <div class="text-gray-400 text-sm">
                    🔄 Проверка совместимости...
                </div>
            `;

            try {
                const componentIds = selectedComponents.map(c => c.id);
                const response = await fetch('@Url.Action("CheckCompatibility", "PcBuilder")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(componentIds)
                });

                if (response.ok) {
                    const result = await response.json();
                    displayCompatibilityResult(result);
                } else {
                    throw new Error('Ошибка проверки совместимости');
                }
            } catch (error) {
                compatibilityResult.innerHTML = `
                    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-3">
                        <div class="text-red-400 text-sm">❌ Ошибка проверки совместимости</div>
                    </div>
                `;
            }
        }

        // Отображение результатов проверки совместимости
        function displayCompatibilityResult(result) {
            const compatibilityResult = document.getElementById('compatibilityResult');
            
            if (result.isCompatible) {
                compatibilityResult.innerHTML = `
                    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-3">
                        <div class="text-green-400 text-sm font-semibold mb-1">✅ ${result.successMessage || 'Все компоненты совместимы!'}</div>
                        ${result.warnings && result.warnings.length > 0 ? `
                            <div class="text-yellow-400 text-xs mt-1">
                                ${result.warnings.join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                compatibilityResult.innerHTML = `
                    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-3">
                        <div class="text-red-400 text-sm font-semibold mb-2">❌ Обнаружены проблемы совместимости:</div>
                        <div class="text-red-300 text-xs space-y-1">
                            ${result.errors.map(error => `• ${error}`).join('<br>')}
                        </div>
                    </div>
                `;
            }
        }

        // Сохранение конфигурации
        async function saveConfiguration() {
            const configurationName = prompt('Введите название для вашей конфигурации:');
            if (!configurationName) return;

            const configuration = {
                name: configurationName,
                description: `Собранный ПК: ${selectedComponents.map(c => c.name).join(', ')}`,
                totalPrice: totalPrice,
                componentIds: selectedComponents.map(c => c.id)
            };

            try {
                const response = await fetch('@Url.Action("SaveConfiguration", "PcBuilder")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(configuration)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Конфигурация успешно сохранена!');
                    } else {
                        alert('Ошибка при сохранении конфигурации');
                    }
                } else {
                    throw new Error('Ошибка сети');
                }
            } catch (error) {
                alert('Ошибка при сохранении конфигурации: ' + error.message);
            }
        }

        // Вспомогательные функции
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(price);
        }

        function getComponentTypeName(type) {
            const typeNames = {
                'MB': 'Материнская плата',
                'CPU': 'Процессор',
                'RAM': 'Оперативная память',
                'GPU': 'Видеокарта',
                'PSU': 'Блок питания',
                'Case': 'Корпус',
                'SSD': 'SSD накопитель',
                'Cooler': 'Охлаждение'
            };
            return typeNames[type] || type;
        }

        // Настройка обработчиков событий
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('saveConfiguration').addEventListener('click', saveConfiguration);
        });
    </script>

    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .component-card {
            transition: all 0.2s ease-in-out;
        }
        
        .component-card:hover {
            transform: translateY(-2px);
        }
        
        .selected-component {
            animation: slideIn 0.3s ease-out;
        }
        
        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}